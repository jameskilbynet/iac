---
- name: Securely add NVIDIA Container Toolkit repository
  hosts: all
  become: true
  tasks:
    - name: Install required packages
      apt:
        name:
          - curl
          - gpg
          - ca-certificates
        state: present
        update_cache: yes

    - name: Download and dearmor NVIDIA GPG key
      shell: |
        curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | \
        gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
      args:
        creates: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg

    - name: Download and rewrite NVIDIA repo list with signed-by
      shell: |
        curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
        sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' > /etc/apt/sources.list.d/nvidia-container-toolkit.list
      args:
        creates: /etc/apt/sources.list.d/nvidia-container-toolkit.list

    - name: Update apt cache
      apt:
        update_cache: yes
      
    - name: Ensure NVIDIA Container Toolkit is installed
      apt:
        name: nvidia-container-toolkit
        state: present

    - name: Configure NVIDIA runtime for Docker
      become: true
      ansible.builtin.command: nvidia-ctk runtime configure --runtime=docker
      args:
        creates: /etc/docker/daemon.json
      notify: Restart Docker service

    - name: Ensure NVIDIA vGPU licensing daemon is enabled
      ansible.builtin.systemd:
        name: nvidia-gridd
        enabled: true
      notify: Start NVIDIA gridd service

    - name: Flush handlers to ensure Docker is restarted before testing
      ansible.builtin.meta: flush_handlers

    - name: Run nvidia-smi inside an Ubuntu container with NVIDIA runtime
      become: true
      ansible.builtin.shell: >
        docker run --rm --runtime=nvidia --gpus all ubuntu nvidia-smi
      register: nvidia_smi_output
      changed_when: false

    - name: Show nvidia-smi result
      ansible.builtin.debug:
        var: nvidia_smi_output.stdout

  handlers:
    - name: Restart Docker service
      ansible.builtin.systemd:
        name: docker
        state: restarted
        enabled: true

    - name: Start NVIDIA gridd service
      ansible.builtin.systemd:
        name: nvidia-gridd
        state: started