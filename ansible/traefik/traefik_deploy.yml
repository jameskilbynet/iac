---
- name: Deploy Traefik with Cloudflare SSL
  hosts: all
  become: true
  gather_facts: true

  vars:
    # Traefik container settings - override via inventory, group_vars, or --extra-vars
    traefik_image: "{{ traefik_docker_image | default('traefik:v3.0') }}"
    traefik_container_name: "{{ traefik_name | default('traefik') }}"
    traefik_config_dir: "{{ traefik_config_path | default('/etc/traefik') }}"
    traefik_cert_dir: "{{ traefik_acme_path | default('/etc/traefik/acme') }}"
    traefik_network: "{{ traefik_docker_network | default('traefik-net') }}"

    # Ports
    traefik_port_web: "{{ traefik_http_port | default(80) }}"
    traefik_port_websecure: "{{ traefik_https_port | default(443) }}"

    # ACME/DNS settings
    acme_delay_before_check: "{{ acme_dns_delay | default(10) }}"
    dns_resolvers: "{{ acme_dns_resolvers | default(['1.1.1.1:53', '8.8.8.8:53']) }}"

    # Logging
    log_level: "{{ traefik_log_level | default('INFO') }}"
    log_format: "{{ traefik_log_format | default('json') }}"
    log_max_size: "{{ traefik_log_max_size | default('10m') }}"
    log_max_files: "{{ traefik_log_max_files | default('3') }}"

    # Health checks
    healthcheck_interval: "{{ traefik_healthcheck_interval | default('30s') }}"
    healthcheck_timeout: "{{ traefik_healthcheck_timeout | default('10s') }}"
    healthcheck_retries: "{{ traefik_healthcheck_retries | default(3) }}"
    healthcheck_start_period: "{{ traefik_healthcheck_start_period | default('30s') }}"

    # Test service (set deploy_test_service to false to skip)
    deploy_test_service: "{{ traefik_deploy_test_service | default(true) }}"
    test_service_name: "{{ traefik_test_container | default('nginx-test') }}"
    test_service_image: "{{ traefik_test_image | default('nginx:alpine') }}"
    test_service_domain: "{{ traefik_test_domain | default('test.' ~ wildcard_domain) }}"

    # Health check polling settings
    healthcheck_poll_retries: "{{ traefik_healthcheck_poll_retries | default(12) }}"
    healthcheck_poll_delay: "{{ traefik_healthcheck_poll_delay | default(5) }}"

    # Dashboard settings (dashboard_domain auto-generated in pre_tasks if not set)
    dashboard_admin_user: "{{ traefik_dashboard_user | default('admin') }}"

    # Required variables (no defaults - must be provided):
    # - cloudflare_api_token: Cloudflare API token for DNS challenge
    # - wildcard_domain: Base domain for wildcard certificates
    # - dashboard_admin_password_hash: htpasswd hash for dashboard auth

    # Static configuration template
    traefik_static_config: |
      # Entry points configuration
      entryPoints:
        web:
          address: ":{{ traefik_port_web }}"
          http:
            redirections:
              entrypoint:
                to: websecure
                scheme: https
                permanent: true
        websecure:
          address: ":{{ traefik_port_websecure }}"

      # Provider configuration
      providers:
        docker:
          endpoint: "unix:///var/run/docker.sock"
          exposedByDefault: false
          network: "{{ traefik_network }}"
          watch: true
        file:
          filename: /etc/traefik/dynamic.yml
          watch: true

      # Certificate resolvers
      certificatesResolvers:
        cloudflare:
          acme:
            storage: "/acme/acme.json"
            dnsChallenge:
              provider: cloudflare
              delayBeforeCheck: {{ acme_delay_before_check }}
              resolvers:
                {% for resolver in dns_resolvers %}
                - "{{ resolver }}"
                {% endfor %}

      # API configuration
      api:
        dashboard: true
        insecure: false

      # Health check endpoint
      ping: {}

      # Global configuration
      global:
        checkNewVersion: false
        sendAnonymousUsage: false

      # Logging
      log:
        level: {{ log_level }}
        format: {{ log_format }}
      accessLog:
        format: {{ log_format }}

    traefik_dynamic_config: |
      # Dynamic configuration for Traefik dashboard
      http:
        middlewares:
          dashboard-auth:
            basicAuth:
              users:
                - "{{ dashboard_admin_user }}:{{ dashboard_admin_password_hash }}"
        routers:
          traefik-dashboard:
            rule: "Host(`{{ dashboard_domain }}`)"
            entryPoints:
              - websecure
            service: api@internal
            tls:
              certResolver: cloudflare
            middlewares:
              - dashboard-auth
          
          # Wildcard certificate request router
          wildcard-cert:
            rule: "Host(`{{ wildcard_domain }}`)"
            entryPoints:
              - websecure
            service: noop@internal
            tls:
              certResolver: cloudflare
              domains:
                - main: {{ wildcard_domain }}
                  sans:
                    - "*.{{ wildcard_domain }}"

  pre_tasks:
    - name: Check if running on supported OS
      ansible.builtin.fail:
        msg: "This playbook only supports Ubuntu/Debian"
      when: ansible_facts['os_family'] not in ['Debian']

    - name: Set dashboard domain based on hostname
      ansible.builtin.set_fact:
        dashboard_domain: "{{ ansible_facts['hostname'] }}-dash.{{ wildcard_domain }}"
      when: 
        - dashboard_domain is not defined
        - wildcard_domain is defined


    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_facts['user_id'] }}"
        groups: docker
        append: true

    - name: Verify Docker is working
      ansible.builtin.command:
        cmd: docker --version
      register: docker_version
      changed_when: false

    - name: Display Docker version
      ansible.builtin.debug:
        msg: "Docker version: {{ docker_version.stdout }}"

  tasks:
    - name: Create Traefik directories
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        mode: "{{ item.mode }}"
        owner: root
        group: root
      loop:
        - { path: "{{ traefik_config_dir }}", mode: "0755" }
        - { path: "{{ traefik_cert_dir }}", mode: "0700" }

    - name: Initialize ACME certificate storage
      ansible.builtin.file:
        path: "{{ traefik_cert_dir }}/acme.json"
        state: touch
        mode: '0600'
        owner: root
        group: root
        modification_time: preserve
        access_time: preserve

    - name: Create Docker network for Traefik
      community.docker.docker_network:
        name: "{{ traefik_network }}"
        state: present
      register: network_result

    - name: Display network creation result
      ansible.builtin.debug:
        msg: "Traefik network created: {{ network_result.network.Name }}"

    - name: Write Traefik static configuration
      ansible.builtin.copy:
        content: "{{ traefik_static_config }}"
        dest: "{{ traefik_config_dir }}/traefik.yml"
        mode: '0644'
        owner: root
        group: root
      register: static_config_result
      notify: Restart Traefik container

    - name: Write Traefik dynamic configuration
      ansible.builtin.copy:
        content: "{{ traefik_dynamic_config }}"
        dest: "{{ traefik_config_dir }}/dynamic.yml"
        mode: '0644'
        owner: root
        group: root
      register: dynamic_config_result
      notify: Restart Traefik container

    - name: Deploy Traefik container
      block:
        - name: Pull Traefik Docker image
          community.docker.docker_image:
            name: "{{ traefik_image }}"
            source: pull
            force_source: false
          register: image_pull_result

        - name: Stop existing Traefik container if running
          community.docker.docker_container:
            name: "{{ traefik_container_name }}"
            state: absent

        - name: Start Traefik container
          community.docker.docker_container:
            name: "{{ traefik_container_name }}"
            image: "{{ traefik_image }}"
            restart_policy: unless-stopped
            state: started
            ports:
              - "{{ traefik_port_web }}:80"
              - "{{ traefik_port_websecure }}:443"
            env:
              CF_DNS_API_TOKEN: "{{ cloudflare_api_token }}"
            volumes:
              - "{{ traefik_config_dir }}/traefik.yml:/etc/traefik/traefik.yml:ro"
              - "{{ traefik_config_dir }}/dynamic.yml:/etc/traefik/dynamic.yml:ro"
              - "{{ traefik_cert_dir }}:/acme"
              - "/var/run/docker.sock:/var/run/docker.sock:ro"
            labels:
              traefik.enable: "true"
              traefik.http.routers.traefik.rule: "Host(`{{ dashboard_domain }}`)"
              traefik.http.routers.traefik.service: "api@internal"
              traefik.http.routers.traefik.entrypoints: "websecure"
              traefik.http.routers.traefik.middlewares: "dashboard-auth@file"
            networks:
              - name: "{{ traefik_network }}"
            log_driver: json-file
            log_options:
              max-size: "{{ log_max_size }}"
              max-file: "{{ log_max_files }}"
            healthcheck:
              test: ["CMD", "traefik", "healthcheck", "--ping"]
              interval: "{{ healthcheck_interval }}"
              timeout: "{{ healthcheck_timeout }}"
              retries: "{{ healthcheck_retries }}"
              start_period: "{{ healthcheck_start_period }}"
          register: container_result

        - name: Wait for Traefik container to become healthy
          community.docker.docker_container_info:
            name: "{{ traefik_container_name }}"
          register: container_info
          until: >
            container_info.container.State.Status == "running" and
            (container_info.container.State.Health.Status | default('starting')) == "healthy"
          retries: "{{ healthcheck_poll_retries }}"
          delay: "{{ healthcheck_poll_delay }}"

        - name: Fail if Traefik container is not healthy
          ansible.builtin.fail:
            msg: "Traefik container failed to become healthy. Status: {{ container_info.container.State.Health.Status | default('unknown') }}"
          when: (container_info.container.State.Health.Status | default('unhealthy')) != "healthy"

      rescue:
        - name: Get Traefik container logs on failure
          ansible.builtin.command:
            cmd: docker logs --tail 100 {{ traefik_container_name }}
          register: failure_logs
          failed_when: false
          changed_when: false

        - name: Display failure logs
          ansible.builtin.debug:
            msg: |
              Traefik deployment failed. Container logs:
              {{ failure_logs.stdout | default('No logs available') }}

        - name: Cleanup failed container
          community.docker.docker_container:
            name: "{{ traefik_container_name }}"
            state: absent
          failed_when: false

        - name: Fail with deployment error
          ansible.builtin.fail:
            msg: "Traefik deployment failed. Check logs above for details."

    - name: Display Traefik container status
      ansible.builtin.debug:
        msg: |
          Traefik Status: {{ container_info.container.State.Status }}
          Health: {{ container_info.container.State.Health.Status | default('N/A') }}
          Started: {{ container_info.container.State.StartedAt }}

    - name: Deploy test nginx service
      community.docker.docker_container:
        name: "{{ test_service_name }}"
        image: "{{ test_service_image }}"
        restart_policy: unless-stopped
        state: started
        networks:
          - name: "{{ traefik_network }}"
        labels:
          traefik.enable: "true"
          traefik.http.routers.nginx-test.rule: "Host(`{{ test_service_domain }}`)"
          traefik.http.routers.nginx-test.entrypoints: "websecure"
          traefik.http.routers.nginx-test.tls: "true"
          traefik.http.services.nginx-test.loadbalancer.server.port: "80"
      when: deploy_test_service | bool

    - name: Skip test service deployment
      ansible.builtin.debug:
        msg: "Test service deployment skipped (deploy_test_service={{ deploy_test_service }})"
      when: not (deploy_test_service | bool)

    - name: Get recent Traefik logs
      ansible.builtin.command:
        cmd: docker logs --tail 50 {{ traefik_container_name }}
      register: traefik_logs
      changed_when: false

    - name: Display ACME and certificate related logs
      ansible.builtin.debug:
        msg: "{{ item }}"
      loop: "{{ traefik_logs.stdout_lines | select('search', 'acme|certificate|error|WARN|ERROR') | list }}"
      when: traefik_logs.stdout_lines | select('search', 'acme|certificate|error|WARN|ERROR') | list | length > 0



  post_tasks:
    - name: Deployment summary
      ansible.builtin.debug:
        msg: |
          ==========================================
          Traefik Deployment Summary
          ==========================================
          Container Status: {{ container_info.container.State.Status }}
          Health Status: {{ container_info.container.State.Health.Status | default('N/A') }}
          Dashboard URL: https://{{ dashboard_domain }}
          {% if deploy_test_service | bool %}
          Test Service URL: https://{{ test_service_domain }}
          {% else %}
          Test Service: Not deployed (disabled)
          {% endif %}

          Next Steps:
          1. Ensure DNS records point to this server:
             - {{ dashboard_domain }} -> {{ ansible_facts['default_ipv4']['address'] }}
          {% if deploy_test_service | bool %}
             - {{ test_service_domain }} -> {{ ansible_facts['default_ipv4']['address'] }}
          {% endif %}

          Note: Dashboard domain auto-generated as {{ ansible_facts['hostname'] }}-dash.{{ wildcard_domain }}
          2. Wait 1-2 minutes for SSL certificates to be issued

          Troubleshooting:
          - Check logs: docker logs {{ traefik_container_name }}
          - Verify network: docker network inspect {{ traefik_network }}
          - Test locally: curl -H "Host: {{ dashboard_domain }}"
          ==========================================

  handlers:
    - name: Restart Traefik container
      community.docker.docker_container:
        name: "{{ traefik_container_name }}"
        state: started
        restart: true
