---
- name: Extract TrueNAS SCALE configuration
  hosts: truenas
  gather_facts: false
  vars:
    truenas_api_key: "{{ lookup('env', 'TRUENAS_API_KEY') }}"
    truenas_base_url: "https://{{ inventory_hostname }}"
    truenas_validate_certs: false
    output_dir: "./extracted_configs"
    
  tasks:
    - name: Verify API key is provided
      ansible.builtin.fail:
        msg: "TRUENAS_API_KEY environment variable must be set"
      when: truenas_api_key == ""

    - name: Create output directory
      ansible.builtin.file:
        path: "{{ output_dir }}/{{ inventory_hostname }}"
        state: directory
        mode: '0755'
      delegate_to: localhost

    - name: Get all pools
      ansible.builtin.uri:
        url: "{{ truenas_base_url }}/api/v2.0/pool"
        method: GET
        headers:
          Authorization: "Bearer {{ truenas_api_key }}"
        validate_certs: "{{ truenas_validate_certs }}"
        status_code: [200]
      register: pools_result

    - name: Get all datasets
      ansible.builtin.uri:
        url: "{{ truenas_base_url }}/api/v2.0/pool/dataset"
        method: GET
        headers:
          Authorization: "Bearer {{ truenas_api_key }}"
        validate_certs: "{{ truenas_validate_certs }}"
        status_code: [200]
      register: datasets_result

    - name: Get NFS shares
      ansible.builtin.uri:
        url: "{{ truenas_base_url }}/api/v2.0/sharing/nfs"
        method: GET
        headers:
          Authorization: "Bearer {{ truenas_api_key }}"
        validate_certs: "{{ truenas_validate_certs }}"
        status_code: [200]
      register: nfs_shares_result

    - name: Get SMB shares
      ansible.builtin.uri:
        url: "{{ truenas_base_url }}/api/v2.0/sharing/smb"
        method: GET
        headers:
          Authorization: "Bearer {{ truenas_api_key }}"
        validate_certs: "{{ truenas_validate_certs }}"
        status_code: [200]
      register: smb_shares_result

    - name: Save pools configuration
      ansible.builtin.copy:
        content: "{{ pools_result.json | to_nice_json }}"
        dest: "{{ output_dir }}/{{ inventory_hostname }}/pools.json"
        mode: '0644'
      delegate_to: localhost

    - name: Save datasets configuration
      ansible.builtin.copy:
        content: "{{ datasets_result.json | to_nice_json }}"
        dest: "{{ output_dir }}/{{ inventory_hostname }}/datasets.json"
        mode: '0644'
      delegate_to: localhost

    - name: Save NFS shares configuration
      ansible.builtin.copy:
        content: "{{ nfs_shares_result.json | to_nice_json }}"
        dest: "{{ output_dir }}/{{ inventory_hostname }}/nfs_shares.json"
        mode: '0644'
      delegate_to: localhost

    - name: Save SMB shares configuration
      ansible.builtin.copy:
        content: "{{ smb_shares_result.json | to_nice_json }}"
        dest: "{{ output_dir }}/{{ inventory_hostname }}/smb_shares.json"
        mode: '0644'
      delegate_to: localhost

    - name: Configuration extraction summary
      ansible.builtin.debug:
        msg: |
          Configuration extracted successfully to {{ output_dir }}/{{ inventory_hostname }}
          - Pools: {{ pools_result.json | length }}
          - Datasets: {{ datasets_result.json | length }}
          - NFS Shares: {{ nfs_shares_result.json | length }}
          - SMB Shares: {{ smb_shares_result.json | length }}
