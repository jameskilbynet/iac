---
- name: Create TrueNAS NFS Shares from CSV
  hosts: localhost
  gather_facts: false
  vars:
    truenas_host: "{{ lookup('env', 'TRUENAS_HOST') }}"
    truenas_api_key: "{{ lookup('env', 'TRUENAS_API_KEY') }}"
    truenas_pool: "{{ lookup('env', 'TRUENAS_POOL') | default('tank', true) }}"
    csv_file: "{{ csv_file_path | default('docker_share_config.csv') }}"
    truenas_api_url: "https://{{ truenas_host }}/api/v2.0"
    validate_certs: false
    share_type: "{{ share_type | default('nfs') }}"  # nfs or smb
    nfs_network: "{{ nfs_network | default('192.168.1.0/24') }}"
    nfs_maproot_user: "{{ nfs_maproot_user | default('root') }}"
    nfs_maproot_group: "{{ nfs_maproot_group | default('wheel') }}"

  tasks:
    - name: Verify required environment variables
      ansible.builtin.assert:
        that:
          - truenas_host is defined
          - truenas_host | length > 0
          - truenas_api_key is defined
          - truenas_api_key | length > 0
        fail_msg: "TRUENAS_HOST and TRUENAS_API_KEY environment variables must be set"

    - name: Read CSV file
      ansible.builtin.read_csv:
        path: "{{ csv_file }}"
        delimiter: ","
      register: dataset_config

    - name: Display shares to be created
      ansible.builtin.debug:
        msg: "Will create {{ share_type | upper }} share: {{ item.share_name }} -> /mnt/{{ truenas_pool }}/{{ item.dataset }}"
      loop: "{{ dataset_config.list }}"
      loop_control:
        label: "{{ item.share_name }}"

    - name: Connect to TrueNAS API
      block:
        - name: Test TrueNAS API connectivity
          ansible.builtin.uri:
            url: "{{ truenas_api_url }}/system/info"
            method: GET
            headers:
              Authorization: "Bearer {{ truenas_api_key }}"
            validate_certs: "{{ validate_certs }}"
            status_code: 200
          register: system_info

        - name: Display TrueNAS system info
          ansible.builtin.debug:
            msg: "Connected to TrueNAS {{ system_info.json.version }} ({{ system_info.json.hostname }})"

      rescue:
        - name: Display API connection failure
          ansible.builtin.fail:
            msg: |
              Failed to connect to TrueNAS API at {{ truenas_api_url }}
              Verify:
              - TRUENAS_HOST is correct
              - TRUENAS_API_KEY is valid
              - TrueNAS is reachable from this host

    - name: Get existing NFS shares
      ansible.builtin.uri:
        url: "{{ truenas_api_url }}/sharing/nfs"
        method: GET
        headers:
          Authorization: "Bearer {{ truenas_api_key }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
      register: existing_nfs_shares
      when: share_type == 'nfs'

    - name: Get existing SMB shares
      ansible.builtin.uri:
        url: "{{ truenas_api_url }}/sharing/smb"
        method: GET
        headers:
          Authorization: "Bearer {{ truenas_api_key }}"
        validate_certs: "{{ validate_certs }}"
        status_code: 200
      register: existing_smb_shares
      when: share_type == 'smb'

    - name: Create NFS shares
      block:
        - name: Create NFS share entries
          ansible.builtin.uri:
            url: "{{ truenas_api_url }}/sharing/nfs"
            method: POST
            headers:
              Authorization: "Bearer {{ truenas_api_key }}"
              Content-Type: "application/json"
            body_format: json
            body:
              path: "/mnt/{{ truenas_pool }}/{{ item.dataset }}"
              comment: "{{ item.description }}"
              enabled: true
              networks:
                - "{{ nfs_network }}"
              hosts: []
              maproot_user: "{{ nfs_maproot_user }}"
              maproot_group: "{{ nfs_maproot_group }}"
              mapall_user: ""
              mapall_group: ""
              security: []
              ro: false
            validate_certs: "{{ validate_certs }}"
            status_code: [200, 409]
          register: nfs_share_creation
          loop: "{{ dataset_config.list }}"
          loop_control:
            label: "{{ item.share_name }}"
          when: "('/mnt/' ~ truenas_pool ~ '/' ~ item.dataset) not in existing_nfs_shares.json | map(attribute='path') | list"

      rescue:
        - name: Display NFS share creation failure
          ansible.builtin.debug:
            msg: |
              NFS share creation failed.
              Results: {{ nfs_share_creation.results | default('N/A') | to_nice_yaml }}

        - name: Fail with NFS share error
          ansible.builtin.fail:
            msg: "Failed to create one or more NFS shares. Check output above."
      when: share_type == 'nfs'

    - name: Create SMB shares
      block:
        - name: Create SMB share entries
          ansible.builtin.uri:
            url: "{{ truenas_api_url }}/sharing/smb"
            method: POST
            headers:
              Authorization: "Bearer {{ truenas_api_key }}"
              Content-Type: "application/json"
            body_format: json
            body:
              path: "/mnt/{{ truenas_pool }}/{{ item.dataset }}"
              name: "{{ item.share_name }}"
              comment: "{{ item.description }}"
              enabled: true
              purpose: "NO_PRESET"
              browsable: true
              guestok: false
              ro: false
              recyclebin: false
              aapl_name_mangling: false
              abe: false
              acl: true
              durablehandle: true
              shadowcopy: true
              streams: true
              fsrvp: false
              auxsmbconf: ""
            validate_certs: "{{ validate_certs }}"
            status_code: [200, 409]
          register: smb_share_creation
          loop: "{{ dataset_config.list }}"
          loop_control:
            label: "{{ item.share_name }}"
          when: "item.share_name not in existing_smb_shares.json | map(attribute='name') | list"

      rescue:
        - name: Display SMB share creation failure
          ansible.builtin.debug:
            msg: |
              SMB share creation failed.
              Results: {{ smb_share_creation.results | default('N/A') | to_nice_yaml }}

        - name: Fail with SMB share error
          ansible.builtin.fail:
            msg: "Failed to create one or more SMB shares. Check output above."
      when: share_type == 'smb'

    - name: Enable and start NFS service
      block:
        - name: Enable NFS service
          ansible.builtin.uri:
            url: "{{ truenas_api_url }}/service/id/nfs"
            method: PUT
            headers:
              Authorization: "Bearer {{ truenas_api_key }}"
              Content-Type: "application/json"
            body_format: json
            body:
              enable: true
            validate_certs: "{{ validate_certs }}"
            status_code: 200

        - name: Start NFS service
          ansible.builtin.uri:
            url: "{{ truenas_api_url }}/service/start"
            method: POST
            headers:
              Authorization: "Bearer {{ truenas_api_key }}"
              Content-Type: "application/json"
            body_format: json
            body:
              service: "nfs"
            validate_certs: "{{ validate_certs }}"
            status_code: 200

      rescue:
        - name: Display NFS service failure
          ansible.builtin.debug:
            msg: "Warning: Failed to enable/start NFS service. Shares were created but service may need manual start."
      when: share_type == 'nfs'

    - name: Enable and start SMB service
      block:
        - name: Enable SMB service
          ansible.builtin.uri:
            url: "{{ truenas_api_url }}/service/id/cifs"
            method: PUT
            headers:
              Authorization: "Bearer {{ truenas_api_key }}"
              Content-Type: "application/json"
            body_format: json
            body:
              enable: true
            validate_certs: "{{ validate_certs }}"
            status_code: 200

        - name: Start SMB service
          ansible.builtin.uri:
            url: "{{ truenas_api_url }}/service/start"
            method: POST
            headers:
              Authorization: "Bearer {{ truenas_api_key }}"
              Content-Type: "application/json"
            body_format: json
            body:
              service: "cifs"
            validate_certs: "{{ validate_certs }}"
            status_code: 200

      rescue:
        - name: Display SMB service failure
          ansible.builtin.debug:
            msg: "Warning: Failed to enable/start SMB service. Shares were created but service may need manual start."
      when: share_type == 'smb'

    - name: Summary of created shares
      ansible.builtin.debug:
        msg: "{{ share_type | upper }} share creation completed successfully."
