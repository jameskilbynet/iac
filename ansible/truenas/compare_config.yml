---
- name: Compare TrueNAS SCALE configurations
  hosts: truenas
  gather_facts: false
  vars:
    truenas_api_key: "{{ lookup('env', 'TRUENAS_API_KEY') }}"
    truenas_base_url: "https://{{ inventory_hostname }}"
    truenas_validate_certs: false
    
  tasks:
    - name: Verify API key is provided
      ansible.builtin.fail:
        msg: "TRUENAS_API_KEY environment variable must be set"
      when: truenas_api_key == ""

    - name: Get all datasets
      ansible.builtin.uri:
        url: "{{ truenas_base_url }}/api/v2.0/pool/dataset"
        method: GET
        headers:
          Authorization: "Bearer {{ truenas_api_key }}"
        validate_certs: "{{ truenas_validate_certs }}"
        status_code: [200]
      register: datasets_result

    - name: Get NFS shares
      ansible.builtin.uri:
        url: "{{ truenas_base_url }}/api/v2.0/sharing/nfs"
        method: GET
        headers:
          Authorization: "Bearer {{ truenas_api_key }}"
        validate_certs: "{{ truenas_validate_certs }}"
        status_code: [200]
      register: nfs_shares_result

    - name: Get SMB shares
      ansible.builtin.uri:
        url: "{{ truenas_base_url }}/api/v2.0/sharing/smb"
        method: GET
        headers:
          Authorization: "Bearer {{ truenas_api_key }}"
        validate_certs: "{{ truenas_validate_certs }}"
        status_code: [200]
      register: smb_shares_result

    - name: Display configuration summary
      ansible.builtin.debug:
        msg: |
          Host: {{ inventory_hostname }}
          - Total Datasets: {{ datasets_result.json | length }}
          - NFS Shares: {{ nfs_shares_result.json | length }}
          - SMB Shares: {{ smb_shares_result.json | length }}

    - name: Set facts for comparison
      ansible.builtin.set_fact:
        host_datasets: "{{ datasets_result.json | map(attribute='name') | list }}"
        host_nfs_shares: "{{ nfs_shares_result.json | map(attribute='path') | list }}"
        host_smb_shares: "{{ smb_shares_result.json | map(attribute='path') | list }}"

- name: Generate comparison report
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display comparison
      ansible.builtin.debug:
        msg: |
          Comparison completed. Review the output above for differences.
          To see detailed differences, use the extract_config.yml playbook
          and compare the JSON files manually.
