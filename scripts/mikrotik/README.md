# MikroTik Switch Provisioning for VMware VCF

This directory contains scripts and templates to fully provision a MikroTik switch for a VMware Cloud Foundation (VCF) environment. The configuration includes all necessary VLANs, bridge setup, routing, and security settings required for VCF deployments.

## Files Overview

- **`provision-mikrotik-vcf.sh`** - Main provisioning script that automates the complete configuration
- **`vcf-template.rsc`** - RouterOS configuration template that can be imported directly
- **`vcf-config.env`** - Configuration file template (generated by the script)
- **`extract-config.sh`** - Configuration extractor wrapper script
- **`extract-mikrotik-config.py`** - Python script to extract existing MikroTik configurations via API
- **`validate-vcf-config.sh`** - Validation script to verify VCF configuration
- **`requirements.txt`** - Python dependencies for API scripts

## Quick Start

1. **Generate configuration template:**
   ```bash
   ./provision-mikrotik-vcf.sh --generate-config
   ```

2. **Edit the configuration file:**
   ```bash
   vim vcf-config.env
   ```

3. **Run the provisioning script:**
   ```bash
   ./provision-mikrotik-vcf.sh
   ```

## VMware VCF Network Requirements

VMware Cloud Foundation requires several dedicated networks for proper operation:

### Core VCF Networks

| Network Type | VLAN ID | Default Network | Purpose |
|--------------|---------|-----------------|---------|
| Management | 100 | 192.168.100.0/24 | ESXi management, vCenter, NSX managers |
| vMotion | 101 | 192.168.101.0/24 | VM migration traffic |
| vSAN | 102 | 192.168.102.0/24 | vSAN storage traffic |
| NSX TEP | 103 | 192.168.103.0/24 | NSX tunnel endpoints |
| NSX Edge TEP | 104 | 192.168.104.0/24 | NSX Edge tunnel endpoints |
| VM Network | 105 | 192.168.105.0/24 | Virtual machine traffic |
| NFS Storage | 106 | 192.168.106.0/24 | External NFS storage (optional) |

### Network Requirements

- **Management Network**: Must be routable to external networks for management access
- **vMotion Network**: High-bandwidth, low-latency network for VM migration
- **vSAN Network**: High-bandwidth network for storage traffic (10GbE recommended)
- **NSX TEP Networks**: Dedicated networks for overlay networking
- **VM Network**: Can include multiple VLANs for different VM workloads

## Prerequisites

### Software Requirements

- **sshpass**: Required for SSH authentication
  ```bash
  # macOS
  brew install sshpass
  
  # Ubuntu/Debian
  sudo apt-get install sshpass
  
  # CentOS/RHEL
  sudo yum install sshpass
  ```

### MikroTik Requirements

- RouterOS version 7.0 or later (recommended for full VLAN filtering support)
- SSH access enabled on the MikroTik device
- Admin credentials for the MikroTik device
- Sufficient ports for your VCF deployment

### Network Planning

Before running the script, plan your network configuration:

1. **Determine VLAN IDs** for each VCF network type
2. **Plan IP addressing** for each network segment
3. **Identify physical ports** for trunk and access connections
4. **Plan uplink connections** to upstream networking equipment

## Configuration File

The configuration file (`vcf-config.env`) contains all customizable parameters:

### Connection Settings
```bash
MIKROTIK_IP="192.168.1.1"          # MikroTik management IP
MIKROTIK_USER="admin"               # Username for SSH access
MIKROTIK_PASSWORD=""                # Password (leave empty to prompt)
```

### Basic Network Configuration
```bash
MANAGEMENT_INTERFACE="ether1"       # Management interface
MANAGEMENT_IP="192.168.100.10/24"  # Management IP for the switch
MANAGEMENT_GATEWAY="192.168.100.1" # Default gateway
```

### VCF VLAN Configuration
```bash
MGMT_VLAN_ID="100"                 # Management VLAN
VMOTION_VLAN_ID="101"              # vMotion VLAN
VSAN_VLAN_ID="102"                 # vSAN VLAN
TEP_VLAN_ID="103"                  # NSX TEP VLAN
EDGE_TEP_VLAN_ID="104"             # NSX Edge TEP VLAN
VM_VLAN_ID="105"                   # VM Network VLAN
NFS_VLAN_ID="106"                  # NFS Storage VLAN
```

### Interface Configuration
```bash
UPLINK_INTERFACES="ether24"                                    # Uplink ports
TRUNK_INTERFACES="ether2,ether3,ether4,ether5,ether6,ether7,ether8"  # Trunk ports
MGMT_ACCESS_PORTS="ether9,ether10"                            # Management access ports
```

## Usage Examples

### Basic Usage

Generate configuration and run with prompts:
```bash
./provision-mikrotik-vcf.sh --generate-config
vim vcf-config.env  # Edit configuration
./provision-mikrotik-vcf.sh
```

### Quick Deployment

Provision with command line parameters:
```bash
./provision-mikrotik-vcf.sh -i 192.168.1.1 -u admin -p mypassword
```

### Dry Run

Test configuration without making changes:
```bash
./provision-mikrotik-vcf.sh --dry-run
```

### Custom Configuration File

Use a custom configuration file:
```bash
./provision-mikrotik-vcf.sh -c my-custom-config.env
```

### Extract Existing Configuration

Extract configuration from an existing MikroTik for reuse:
```bash
./extract-config.sh                           # Extract from 192.168.3.1
./extract-config.sh -H 192.168.1.1           # Different host
./extract-config.sh --ssl --json             # SSL with JSON output
```

## Script Features

### Automated Configuration

- **System Setup**: Identity, time zone, NTP, DNS
- **Bridge Creation**: RSTP-enabled bridge with VLAN filtering
- **VLAN Configuration**: All required VCF VLANs with proper tagging
- **IP Addressing**: Gateway IPs for each VLAN
- **Routing**: Default route and IP forwarding
- **Security**: Disable unnecessary services, configure firewall
- **DHCP**: Optional DHCP server for VM networks
- **SNMP**: Optional SNMP configuration for monitoring

### Safety Features

- **Configuration Backup**: Automatic backup before changes
- **Prerequisite Checking**: Validates requirements before execution
- **Connection Testing**: Verifies SSH connectivity
- **Error Handling**: Stops on errors to prevent partial configurations
- **Dry Run Mode**: Test configuration without applying changes

## Manual Configuration Alternative

If you prefer manual configuration, you can use the RouterOS template:

1. **Upload template to MikroTik:**
   ```bash
   scp vcf-template.rsc admin@192.168.1.1:/
   ```

2. **Import configuration:**
   ```bash
   ssh admin@192.168.1.1
   /import file-name=vcf-template.rsc
   ```

3. **Customize as needed** using the MikroTik CLI or WebFig interface

## Configuration Extraction

You can extract configuration from an existing MikroTik switch to create reusable scripts:

### Prerequisites for Extraction

- Python 3.x installed
- MikroTik API enabled (ports 8728/8729)
- Network access to the MikroTik device

### Installation

Install Python dependencies:
```bash
pip3 install -r requirements.txt
```

### Extract Configuration

1. **Basic extraction:**
   ```bash
   ./extract-config.sh -H 192.168.3.1 -u admin
   ```

2. **SSL extraction with JSON output:**
   ```bash
   ./extract-config.sh -H 192.168.3.1 --ssl --json
   ```

3. **Custom output location:**
   ```bash
   ./extract-config.sh -o ./extracted-configs --prefix prod-switch
   ```

### Generated Files

- **`.rsc` file** - RouterOS script for importing to another device
- **`.env` file** - Environment file compatible with provisioning script
- **`.json` file** - Raw JSON data (if --json option used)

### Using Extracted Configuration

```bash
# Use extracted environment file
./provision-mikrotik-vcf.sh -c extracted_192_168_3_1_20231201_143022.env

# Import RouterOS script to another device
scp extracted_192_168_3_1_20231201_143022.rsc admin@192.168.1.10:/
ssh admin@192.168.1.10 '/import file-name=extracted_192_168_3_1_20231201_143022.rsc'
```

## Port Configuration Examples

### Typical 24-Port Switch Layout

```
ether1     - Management/WAN connection
ether2-8   - ESXi host trunk ports
ether9-10  - Management access ports
ether11-20 - Additional trunk ports for expansion
ether21-23 - Spare ports
ether24    - Uplink to core network
```

### ESXi Host Connection

Each ESXi host should connect to a trunk port configured with all required VLANs:
- Management VLAN (tagged)
- vMotion VLAN (tagged)
- vSAN VLAN (tagged)
- NSX TEP VLAN (tagged)
- VM Networks (tagged)

## Troubleshooting

### Common Issues

1. **SSH Connection Failed**
   - Verify MikroTik IP address
   - Ensure SSH is enabled on MikroTik
   - Check username/password
   - Verify network connectivity

2. **sshpass Not Found**
   ```bash
   brew install sshpass  # macOS
   ```

3. **Configuration Errors**
   - Check the configuration file syntax
   - Ensure all required variables are set
   - Verify VLAN IDs don't conflict

4. **VLAN Connectivity Issues**
   - Verify trunk port configuration
   - Check VLAN tagging on connected devices
   - Ensure proper routing between VLANs

### Verification Commands

After provisioning, verify the configuration:

```bash
# Check bridge configuration
/interface bridge print

# Verify VLAN configuration
/interface vlan print
/interface bridge vlan print

# Check IP addresses
/ip address print

# Verify routing
/ip route print

# Test connectivity
/ping 192.168.100.1
```

## Security Considerations

### Default Security Settings

The script implements several security best practices:

- Disables telnet, FTP, and HTTP services
- Enables SSH, HTTPS, and API services for management
- Implements basic firewall rules
- Restricts management access to specific VLANs

### Additional Security Recommendations

1. **Change default passwords** for admin user
2. **Create dedicated management users** with limited privileges
3. **Implement certificate-based SSH authentication**
4. **Configure proper firewall rules** for inter-VLAN communication
5. **Secure API access** by restricting source IPs or using API-SSL
6. **Enable logging and monitoring** via SNMP or syslog
7. **Regular firmware updates** for security patches

## Performance Tuning

### QoS Configuration

The template includes basic QoS rules for VCF traffic:
- vSAN traffic gets highest priority (storage critical)
- vMotion traffic gets medium priority
- Regular VM traffic uses standard priority

### Hardware Recommendations

- **10GbE uplinks** for high-bandwidth VCF deployments
- **Sufficient buffer memory** for vSAN and vMotion traffic
- **Multiple uplinks** for redundancy and bandwidth aggregation

## Integration with VCF

### vSphere Integration

After switch configuration, configure vSphere networking:

1. **Create port groups** matching the VLAN configuration
2. **Configure vSphere switches** with proper VLAN tags
3. **Assign vmkernels** to appropriate VLANs
4. **Test connectivity** between all VCF components

### NSX-T Integration

Ensure NSX-T configuration matches switch VLANs:

1. **TEP VLAN configuration** must match switch settings
2. **Edge TEP connectivity** through dedicated VLAN
3. **Physical network integration** for overlay networking

## Monitoring and Maintenance

### Log Monitoring

Configure centralized logging:
```bash
/system logging action
add name=remote target=remote remote=192.168.100.100 remote-port=514

/system logging
add topics=info action=remote
```

### SNMP Monitoring

Enable SNMP for network monitoring:
```bash
/snmp
set enabled=yes contact=admin location="VCF Datacenter"

/snmp community
set [find default=yes] name=vcf-monitoring
```

### Backup Strategy

Regular configuration backups:
```bash
# Create automated backup
/system backup save name=vcf-backup-$(date +%Y%m%d)

# Export configuration
/export file=vcf-config-$(date +%Y%m%d)
```

## Support and Troubleshooting

### Getting Help

1. **Check MikroTik documentation** for RouterOS-specific issues
2. **VMware VCF documentation** for network requirements
3. **Community forums** for MikroTik and VMware communities

### API Management

The MikroTik API is enabled for programmatic management:

- **API Port**: 8728 (unencrypted)
- **API-SSL Port**: 8729 (encrypted)

#### API Usage Examples

Using Python with the `routeros_api` library:
```python
import routeros_api

# Connect to MikroTik API
connection = routeros_api.RouterOsApiPool(
    '192.168.100.10',  # MikroTik IP
    username='admin',
    password='your_password',
    port=8728
)
api = connection.get_api()

# Get VLAN interfaces
vlans = api.get_resource('/interface/vlan')
print(vlans.get())

# Add a new VLAN
vlans.add(name='vlan200', vlan_id='200', interface='br-vcf')
```

### Useful Resources

- [MikroTik RouterOS Documentation](https://help.mikrotik.com/)
- [MikroTik API Documentation](https://help.mikrotik.com/docs/display/ROS/API)
- [VMware VCF Network Guide](https://docs.vmware.com/en/VMware-Cloud-Foundation/)
- [NSX-T Documentation](https://docs.vmware.com/en/VMware-NSX-T-Data-Center/)

## License

This configuration is provided as-is for educational and production use. Modify as needed for your specific environment.

## Contributing

To contribute improvements:

1. Test changes in a lab environment
2. Update documentation accordingly
3. Submit changes with clear descriptions
4. Include validation steps for new features